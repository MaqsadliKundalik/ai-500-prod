# Render Deployment Guide for AI-500 Backend
# ==========================================

## Prerequisites
- GitHub account with your code pushed to a repository
- Render account (free tier available at https://render.com)
- AWS S3 or DigitalOcean Spaces for large model files (optional)

## Quick Start - Automatic Deployment

### 1. Connect GitHub Repository

1. Go to https://render.com/dashboard
2. Click "New +" → "Blueprint"
3. Connect your GitHub repository
4. Select branch: `main`
5. Render will automatically detect `render.yaml`

### 2. Configure Environment Variables

Render will create services from `render.yaml`. You need to manually set these **secret** environment variables:

**In Backend Service (ai500-backend):**

```bash
# Security Keys (generate strong random strings)
SECRET_KEY=<generate-with-openssl-rand-hex-32>
JWT_SECRET_KEY=<generate-with-openssl-rand-hex-32>

# FDA API Key (get from https://open.fda.gov/apis/authentication/)
FDA_API_KEY=<your-fda-api-key>

# Sentry (optional, get from https://sentry.io)
SENTRY_DSN=<your-sentry-dsn>

# CORS (update with your actual frontend domain)
CORS_ORIGINS=https://your-frontend.onrender.com,https://your-custom-domain.com
```

**Generate SECRET_KEY and JWT_SECRET_KEY:**
```bash
# On Linux/Mac:
openssl rand -hex 32

# On Windows (PowerShell):
[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Minimum 0 -Maximum 256 }))
```

### 3. Upload AI Models to Cloud Storage (Required for Free Tier)

**Option A: AWS S3**
```bash
# Install AWS CLI
pip install awscli

# Configure AWS
aws configure

# Upload models
aws s3 cp models/pill_recognition.pt s3://your-bucket/models/
aws s3 cp models/biobert_ddi_model.pt s3://your-bucket/models/

# Make public or generate presigned URLs
aws s3 presign s3://your-bucket/models/pill_recognition.pt --expires-in 604800
```

**Option B: DigitalOcean Spaces**
```bash
# Install s3cmd
pip install s3cmd

# Configure
s3cmd --configure

# Upload
s3cmd put models/pill_recognition.pt s3://your-space/models/
```

**Update environment variables with model URLs:**
```bash
PILL_RECOGNITION_MODEL_URL=https://your-bucket.s3.amazonaws.com/models/pill_recognition.pt
DDI_MODEL_URL=https://your-bucket.s3.amazonaws.com/models/biobert_ddi_model.pt
```

### 4. Deploy

Click **"Apply"** in Render dashboard. The system will:

1. ✅ Create PostgreSQL database (ai500-db)
2. ✅ Create Redis instance (ai500-redis)
3. ✅ Build Docker image from Dockerfile
4. ✅ Wait for database to be ready
5. ✅ Download AI models from S3
6. ✅ Run Alembic migrations
7. ✅ Seed database with initial data
8. ✅ Start FastAPI server

**First deployment takes ~5-10 minutes.**

### 5. Verify Deployment

After deployment completes:

- **Backend URL**: https://ai500-backend.onrender.com
- **Health Check**: https://ai500-backend.onrender.com/health
- **API Docs**: https://ai500-backend.onrender.com/docs

Test the health endpoint:
```bash
curl https://ai500-backend.onrender.com/health
```

Expected response:
```json
{
  "status": "healthy",
  "database": "connected",
  "redis": "connected"
}
```

## Manual Deployment (Alternative)

If you don't want to use Blueprint:

### 1. Create PostgreSQL Database
1. New + → PostgreSQL
2. Name: `ai500-db`
3. Database: `ai500`
4. Plan: Free

### 2. Create Redis
1. New + → Redis
2. Name: `ai500-redis`
3. Plan: Free

### 3. Create Web Service
1. New + → Web Service
2. Connect repository
3. Name: `ai500-backend`
4. Environment: Docker
5. Dockerfile Path: `./Dockerfile`
6. Plan: Free (or Starter for 512 MB RAM)
7. Advanced → Add environment variables (copy from `render.yaml`)

## Service Plans

### Free Tier (Development/Testing)
- **Web Service**: 512 MB RAM, sleeps after 15 min inactivity
- **Database**: 1 GB storage, 100 connections
- **Redis**: 25 MB, expires in 90 days
- **Cost**: $0/month

### Starter Tier (Production)
- **Web Service**: $7/month (512 MB RAM, always on)
- **Database**: $7/month (1 GB storage, persistent)
- **Redis**: $10/month (256 MB, persistent)
- **Disk**: $1/GB/month (for models if not using S3)
- **Total**: ~$25/month

### Standard Tier (High Traffic)
- **Web Service**: $25/month (2 GB RAM, 2 workers)
- **Database**: $20/month (10 GB storage)
- **Redis**: $30/month (1 GB)
- **Total**: ~$75/month

## Environment Variables Reference

### Required (Must Set Manually)
```bash
SECRET_KEY=<random-string-32-chars>
JWT_SECRET_KEY=<random-string-32-chars>
FDA_API_KEY=<your-fda-api-key>
CORS_ORIGINS=https://your-frontend.com
```

### Auto-Generated by Render
```bash
DATABASE_URL=postgresql://user:pass@host:5432/db
REDIS_URL=redis://host:6379
```

### Optional (With Defaults)
```bash
# Application
APP_ENV=production
LOG_LEVEL=INFO

# Features (enable/disable)
ENABLE_PILL_RECOGNITION=true
ENABLE_DRUG_INTERACTION=true
ENABLE_VOICE_ASSISTANT=true

# Model URLs (if using S3)
PILL_RECOGNITION_MODEL_URL=https://s3.../pill_recognition.pt
DDI_MODEL_URL=https://s3.../biobert_ddi_model.pt

# Deployment Flags
RUN_MIGRATIONS=true  # Run migrations on startup
SEED_DATABASE=true   # Seed if database is empty
```

## Database Management

### Run Migrations Manually
```bash
# SSH into service
render ssh ai500-backend

# Run migrations
alembic upgrade head
```

### Seed Database Manually
```bash
render ssh ai500-backend

# Seed base data
python app/scripts/seed_data.py

# Seed AI enhancements
python app/scripts/seed_ai_enhancements.py
```

### Access Database
```bash
# Get DATABASE_URL from Render dashboard
psql $DATABASE_URL

# Or use pgAdmin
# Host: Available in Render dashboard
# Port: 5432
# User: postgres
# Password: From DATABASE_URL
```

## Monitoring

### View Logs
```bash
# Real-time logs in dashboard
https://dashboard.render.com/web/<service-id>/logs

# Or via CLI
render logs ai500-backend --tail
```

### Health Checks
Render automatically monitors `/health` endpoint every 30 seconds.

### Sentry Integration (Optional)
1. Create account at https://sentry.io
2. Create new project (Python/FastAPI)
3. Copy DSN
4. Add to environment variables:
   ```bash
   SENTRY_DSN=https://...@sentry.io/...
   ```

## Troubleshooting

### Build Failed - Out of Memory
**Solution**: Upgrade to Starter plan ($7/month) for 512 MB RAM

### Service Sleeps After 15 Minutes
**Free tier limitation**. Solutions:
- Upgrade to Starter plan ($7/month)
- Use cron job to ping every 10 minutes: https://cron-job.org

### Database Migration Failed
```bash
# Check logs
render logs ai500-backend

# Manually run migration
render ssh ai500-backend
alembic upgrade head
```

### Model Download Failed
```bash
# Check model URLs are accessible
curl -I $PILL_RECOGNITION_MODEL_URL

# Verify S3 bucket permissions (public read)
aws s3api get-bucket-policy --bucket your-bucket

# Try downloading manually
render ssh ai500-backend
curl -L $DDI_MODEL_URL -o /app/models/biobert_ddi_model.pt
```

### Database Seeding Takes Too Long
**Solution**: Reduce seed data size in `app/scripts/seed_ai_enhancements.py`:
```python
# Line 50: Reduce from 100-150 to 20-30
num_entries = random.randint(20, 30)
```

## Custom Domain Setup

1. Go to Service → Settings → Custom Domain
2. Add your domain: `api.yourdomain.com`
3. Add DNS records to your domain:
   ```
   Type: CNAME
   Name: api
   Value: ai500-backend.onrender.com
   ```
4. Wait for SSL certificate (automatic)

## CI/CD - Automatic Deployments

With `render.yaml`, every push to `main` branch triggers automatic deployment:

1. Push code to GitHub
2. Render detects changes
3. Builds new Docker image
4. Runs migrations
5. Deploys new version (zero downtime)

**Disable auto-deploy:**
```yaml
# In render.yaml
services:
  - type: web
    autoDeploy: false  # Change to false
```

## Backup Strategy

### Database Backups
```bash
# Manual backup
render pg-backup ai500-db

# Scheduled backups (Starter plan+)
# Configure in Dashboard → Database → Backups
```

### Model Files Backup
Store in S3 with versioning enabled:
```bash
aws s3api put-bucket-versioning \
  --bucket your-bucket \
  --versioning-configuration Status=Enabled
```

## Cost Optimization

### Free Tier Tips
1. Use S3 for models (avoid paid disk)
2. Accept 15-minute sleep delay
3. Share single database across multiple projects
4. Use free Redis (25 MB sufficient for sessions)

### Production Tips
1. Use CDN for static assets (Cloudflare R2 free tier)
2. Enable Redis caching (reduce database queries)
3. Use connection pooling (SQLAlchemy default)
4. Monitor usage in Render dashboard

## Support & Resources

- **Render Docs**: https://render.com/docs
- **Render Status**: https://status.render.com
- **Community Forum**: https://community.render.com
- **Support**: support@render.com

## Next Steps

After successful deployment:

1. ✅ Test all API endpoints
2. ✅ Configure frontend CORS
3. ✅ Set up Sentry monitoring
4. ✅ Configure custom domain
5. ✅ Enable database backups
6. ✅ Document API for frontend team
7. ✅ Load test with realistic traffic
